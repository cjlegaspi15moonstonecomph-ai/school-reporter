<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<!-- Login -->
<div id="loginBox" class="max-w-md mx-auto bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-4 text-center">Admin Login</h1>
  <form id="loginForm" class="space-y-4">
    <input id="username" type="text" placeholder="Username" class="w-full border px-3 py-2 rounded" required>
    <input id="password" type="password" placeholder="Password" class="w-full border px-3 py-2 rounded" required>
    <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Login</button>
  </form>
  <p id="loginMsg" class="mt-2 text-red-600 font-semibold text-center"></p>
</div>

<!-- Dashboard -->
<div id="adminApp" class="hidden max-w-6xl mx-auto">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Reports Dashboard</h1>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
  </div>

  <div class="mb-6 grid grid-cols-1 md:grid-cols-6 gap-3">
    <input type="text" id="q" placeholder="Search by name/type/ID" class="border px-3 py-2 rounded col-span-2">
    <input type="date" id="dateFrom" class="border px-3 py-2 rounded">
    <input type="date" id="dateTo" class="border px-3 py-2 rounded">
    <select id="typeFilter" class="border px-3 py-2 rounded">
      <option value="">All Types</option>
      <option value="Bullying">Bullying</option>
      <option value="Harassment">Harassment</option>
      <option value="Other">Other</option>
    </select>
    <button id="searchBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Filter</button>
    <button id="resetBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Reset</button>
  </div>

  <div class="mb-4">
    <a id="downloadLink" href="#" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 inline-block">Download CSV</a>
  </div>

  <div id="reportsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</div>

<script>
const showLogin = () => { document.getElementById('loginBox').classList.remove('hidden'); document.getElementById('adminApp').classList.add('hidden'); }
const showApp = () => { document.getElementById('loginBox').classList.add('hidden'); document.getElementById('adminApp').classList.remove('hidden'); }

async function checkSession(){
  try {
    const res = await fetch('/admin/check', { credentials: 'include' });
    if(res.ok) showApp(); else showLogin();
  } catch(e){ showLogin(); }
}
checkSession();

document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  try {
    const res = await fetch('/admin/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username,password}),
      credentials:'include'
    });
    if(res.ok){ 
      showApp(); 
      await loadReports(); 
    } else { 
      const d = await res.json(); 
      document.getElementById('loginMsg').innerText = d.message || 'Login failed'; 
    }
  } catch(e){
    document.getElementById('loginMsg').innerText = 'Server error';
  }
});

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await fetch('/admin/logout', { credentials:'include' });
  showLogin();
});

async function loadReports(){
  const q = document.getElementById('q').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  const type = document.getElementById('typeFilter').value;
  const params = new URLSearchParams({ q, dateFrom, dateTo, type });

  try {
    const res = await fetch('/admin/reports?' + params.toString(), { credentials:'include' });
    const data = await res.json();
    const list = document.getElementById('reportsList');
    list.innerHTML = '';

    data.forEach(r=>{
      const typeColor = r.type==='Bullying'?'bg-red-200 text-red-800':r.type==='Harassment'?'bg-yellow-200 text-yellow-800':'bg-blue-200 text-blue-800';
      const d = document.createElement('div');
      d.className = 'bg-white rounded-lg shadow p-5 border-l-4 border-gray-300 hover:shadow-lg transition';
      
      let filesHTML = '';
      if(r.files && r.files.length){
        filesHTML = r.files.map(f=>{
          const ext = f.split('.').pop().toLowerCase();
          if(['mp4','webm','ogg'].includes(ext)){
            return `<video controls class="max-w-full mb-2"><source src="${f}" type="video/${ext}"></video>`;
          } else {
            return `<img src="${f}" class="max-w-full mb-2"/>`;
          }
        }).join('');
      }

      d.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <span class="font-semibold text-gray-700">#${r.id}</span>
          <span class="px-2 py-1 rounded text-sm ${typeColor}">${r.type}</span>
        </div>
        <div class="text-gray-700 mb-2"><strong>Name:</strong> ${r.anonymous?'<em>Anonymous</em>':(r.name||'N/A')}</div>
        <div class="text-gray-800 mb-2"><strong>Report:</strong> ${(r.text||'').replace(/</g,'&lt;')}</div>
        <div class="text-gray-500 text-sm mb-2">${new Date(r.date).toLocaleString()}</div>
        <div class="mb-2">${filesHTML}</div>
      `;
      list.appendChild(d);
    });

    document.getElementById('downloadLink').href = '/admin/download?' + params.toString();
  } catch(e){
    console.error(e);
  }
}

document.getElementById('searchBtn').addEventListener('click', ()=> loadReports());
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('q').value='';
  document.getElementById('dateFrom').value='';
  document.getElementById('dateTo').value='';
  document.getElementById('typeFilter').value='';
  loadReports();
});
</script>

</body>
</html>
